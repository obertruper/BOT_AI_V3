# Руководство по настройке Hedge Mode

## Что такое Hedge Mode?

Hedge Mode (режим хеджирования) - это режим торговли на фьючерсах, который позволяет одновременно держать длинные (long) и короткие (short) позиции по одному и тому же инструменту. Это дает трейдерам больше гибкости в управлении рисками и реализации сложных торговых стратегий.

### Основные отличия от One-Way Mode

| One-Way Mode | Hedge Mode |
|--------------|------------|
| Только одна позиция на символ | Long и short позиции одновременно |
| position_idx = 0 | position_idx = 1 (buy), 2 (sell) |
| Проще для начинающих | Больше возможностей для стратегий |
| Автоматическое закрытие противоположных позиций | Независимое управление позициями |

## Настройка Hedge Mode в BOT_AI_V3

### 1. Конфигурация system.yaml

Добавьте секцию `trading` в файл `config/system.yaml`:

```yaml
# Настройки торговли
trading:
  hedge_mode: true          # Включить hedge mode
  category: linear          # Тип торговли (linear для USDT фьючерсов)
  leverage: 5               # Плечо по умолчанию (1-100)
  max_positions_per_direction: 1  # Максимум позиций на каждое направление
```

### 2. Проверка настроек на бирже

Перед запуском системы убедитесь, что на бирже включен hedge mode:

#### Для Bybit

1. Войдите в аккаунт на bybit.com
2. Перейдите в раздел "Деривативы" → "USDT бессрочные"
3. Нажмите на настройки (шестеренка) → "Настройки позиций"
4. Выберите "Hedge Mode"

### 3. Требования к API ключам

Убедитесь, что ваши API ключи имеют следующие разрешения:

- Чтение позиций
- Создание/отмена ордеров
- Управление позициями
- Доступ к фьючерсам

### 4. Переменные окружения

В файле `.env` укажите:

```bash
# API ключи Bybit
BYBIT_API_KEY=ваш_api_ключ
BYBIT_API_SECRET=ваш_secret_ключ

# Торговые настройки (опционально, берутся из system.yaml)
DEFAULT_LEVERAGE=5
HEDGE_MODE=true
```

## Использование Hedge Mode

### Создание позиций

При создании ордеров система автоматически определяет правильный `position_idx`:

```python
# Для покупки (long позиция)
order = OrderRequest(
    symbol="BTCUSDT",
    side=OrderSide.BUY,  # position_idx будет 1
    # ...
)

# Для продажи (short позиция)
order = OrderRequest(
    symbol="BTCUSDT",
    side=OrderSide.SELL,  # position_idx будет 2
    # ...
)
```

### Управление позициями

В hedge mode вы можете:

- Держать long и short позиции одновременно
- Независимо управлять размером каждой позиции
- Использовать разные стоп-лоссы и тейк-профиты
- Частично закрывать позиции в любом направлении

## Тестирование настройки

### 1. Проверка конфигурации

```bash
# Активируйте виртуальное окружение
source venv/bin/activate

# Запустите тест
python test_order_force.py
```

Вы должны увидеть:

```
1️⃣ Конфигурация:
   Hedge mode: True
   Default leverage: 5x
   Trading category: linear
```

### 2. Проверка состояния аккаунта

```bash
python check_account_detailed.py
```

Это покажет:

- Текущий режим позиций
- Доступный баланс
- Открытые позиции с их position_idx

### 3. Создание тестового ордера

Скрипт `test_order_force.py` автоматически:

1. Проверит конфигурацию hedge mode
2. Создаст минимальный тестовый ордер
3. Отменит его через 3 секунды

## Устранение неполадок

### Ошибка "position idx not match position mode"

**Причина**: Несоответствие между настройками в системе и на бирже

**Решение**:

1. Проверьте `trading.hedge_mode` в `config/system.yaml`
2. Убедитесь, что на бирже включен hedge mode
3. Перезапустите систему: `python unified_launcher.py`

### Ошибка "Insufficient margin"

**Причина**: Недостаточно свободных средств для открытия позиции

**Решение**:

1. Проверьте доступный баланс
2. Закройте неиспользуемые позиции
3. Уменьшите размер ордера или leverage

### Позиции не открываются

**Возможные причины**:

1. Неправильные API ключи
2. Недостаточные разрешения API
3. Слишком маленький размер ордера (минимум 0.001 BTC)

## Примеры стратегий с Hedge Mode

### 1. Хеджирование рисков

```python
# Основная long позиция
long_order = create_order("BTCUSDT", OrderSide.BUY, 0.1)

# Защитная short позиция (50% от основной)
hedge_order = create_order("BTCUSDT", OrderSide.SELL, 0.05)
```

### 2. Парная торговля

```python
# Long на росте
if bullish_signal:
    buy_order = create_order("BTCUSDT", OrderSide.BUY, size)

# Short на падении (независимо от long)
if bearish_signal:
    sell_order = create_order("BTCUSDT", OrderSide.SELL, size)
```

### 3. Скальпинг в обе стороны

Hedge mode позволяет одновременно скальпировать движения вверх и вниз, не закрывая противоположные позиции.

## Лучшие практики

1. **Управление рисками**: Всегда устанавливайте стоп-лоссы для обеих позиций
2. **Мониторинг маржи**: Следите за использованием маржи - hedge позиции требуют больше обеспечения
3. **Балансировка**: Регулярно проверяйте баланс между long и short позициями
4. **Логирование**: Включите детальное логирование для отслеживания всех операций

## Заключение

Hedge mode предоставляет продвинутые возможности для управления позициями и реализации сложных торговых стратегий. При правильной настройке и использовании, он может значительно улучшить управление рисками и увеличить прибыльность торговли.

Для дополнительной информации см.:

- [Конфигурационное руководство](CONFIGURATION_GUIDE.md)
- [Документация Bybit по Hedge Mode](https://www.bybit.com/en-US/help-center/article/Position-Mode)
