# Enhanced SL/TP - –§—É–Ω–∫—Ü–∏–∏ –∏–∑ V2

## üìã –°–ø–∏—Å–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ BOT_AI_V2

### ‚úÖ 1. Partial Take Profit (–ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π)

**–û–ø–∏—Å–∞–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ –ø–æ—ç—Ç–∞–ø–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø—Ä–∏–±—ã–ª–∏.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

- –¢–∞–±–ª–∏—Ü–∞ `partial_tp_history` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
- –ú–µ—Ç–æ–¥ `check_partial_tp()` –≤ `enhanced_manager.py`
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `close_ratio` (0.25 = 25% –ø–æ–∑–∏—Ü–∏–∏)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SL –ø–æ—Å–ª–µ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**:

```yaml
partial_take_profit:
  enabled: true
  update_sl_after_partial: true
  levels:
    - percent: 1.0      # –ü—Ä–∏ 1% –ø—Ä–∏–±—ã–ª–∏
      close_ratio: 0.25 # –ó–∞–∫—Ä—ã—Ç—å 25% –ø–æ–∑–∏—Ü–∏–∏
    - percent: 2.0      # –ü—Ä–∏ 2% –ø—Ä–∏–±—ã–ª–∏
      close_ratio: 0.25 # –ó–∞–∫—Ä—ã—Ç—å –µ—â–µ 25%
    - percent: 3.0      # –ü—Ä–∏ 3% –ø—Ä–∏–±—ã–ª–∏
      close_ratio: 0.50 # –ó–∞–∫—Ä—ã—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 50%
```

### ‚úÖ 2. Profit Protection (–ó–∞—â–∏—Ç–∞ –ø—Ä–∏–±—ã–ª–∏)

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏.

**–§—É–Ω–∫—Ü–∏–∏**:

- **Breakeven** (–±–µ–∑—É–±—ã—Ç–æ–∫): –ü–µ—Ä–µ–Ω–æ—Å SL –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—Ö–æ–¥–∞ + offset –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏
- **Lock Levels**: –ó–∞—â–∏—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø—Ä–∏–±—ã–ª–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á—Ä–µ–∑–º–µ—Ä–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**:

```yaml
profit_protection:
  enabled: true
  breakeven_percent: 1.0    # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –±–µ–∑—É–±—ã—Ç–∫–∞ –ø—Ä–∏ 1% –ø—Ä–∏–±—ã–ª–∏
  breakeven_offset: 0.2     # –°–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ 0.2%
  lock_percent:
    - trigger: 2.0          # –ü—Ä–∏ 2% –ø—Ä–∏–±—ã–ª–∏
      lock: 1.0             # –ó–∞—â–∏—Ç–∏—Ç—å 1% –ø—Ä–∏–±—ã–ª–∏
    - trigger: 3.0          # –ü—Ä–∏ 3% –ø—Ä–∏–±—ã–ª–∏
      lock: 2.0             # –ó–∞—â–∏—Ç–∏—Ç—å 2% –ø—Ä–∏–±—ã–ª–∏
    - trigger: 4.0          # –ü—Ä–∏ 4% –ø—Ä–∏–±—ã–ª–∏
      lock: 3.0             # –ó–∞—â–∏—Ç–∏—Ç—å 3% –ø—Ä–∏–±—ã–ª–∏
  max_updates: 5            # –ú–∞–∫—Å–∏–º—É–º 5 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
```

### ‚úÖ 3. Enhanced Trailing Stop

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–π–ª–∏–Ω–≥ —Å—Ç–æ–ø —Å —É—á–µ—Ç–æ–º —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π.

**–§—É–Ω–∫—Ü–∏–∏**:

- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π —à–∞–≥ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ (fixed, percentage, ATR-based, adaptive)

### ‚úÖ 4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

**–¢–∞–±–ª–∏—Ü–∞ `partial_tp_history`**:

```sql
CREATE TABLE partial_tp_history (
    id INTEGER PRIMARY KEY,
    trade_id INTEGER NOT NULL,
    level INTEGER NOT NULL,
    percent DECIMAL(10,2) NOT NULL,
    close_ratio DECIMAL(10,4) NOT NULL,
    close_qty DECIMAL(20,8) NOT NULL,
    price DECIMAL(20,8) NOT NULL,
    order_id VARCHAR(255),
    status VARCHAR(50) DEFAULT 'pending',
    error TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ‚úÖ 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Trading Engine

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ enhanced SL/TP –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Ü–µ–Ω —á–µ—Ä–µ–∑ exchange API
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ exchange –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã V2

1. **–ì–∏–±–∫–æ—Å—Ç—å**: –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Ä–æ–≤–Ω–µ–π TP
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ó–∞—â–∏—Ç–∞ –ø—Ä–∏–±—ã–ª–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö
4. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –ë–î
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
python test_enhanced_sltp.py
```

### –ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º

Enhanced SL/TP –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∏—Å—Ç–µ–º—ã –µ—Å–ª–∏ –≤ `config/system.yaml`:

```yaml
enhanced_sltp:
  enabled: true
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```sql
-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ partial TP
SELECT * FROM partial_tp_history ORDER BY created_at DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º
SELECT level, COUNT(*) as count, AVG(percent) as avg_percent
FROM partial_tp_history
WHERE status = 'filled'
GROUP BY level;
```

## üìù –ó–∞–º–µ—Ç–∫–∏ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏

1. –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ V2 —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ V3
2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ hedge mode (positionIdx)
3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è 50+ —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–∞—Ä

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –±–∏—Ä–∂–µ –≤–∫–ª—é—á–µ–Ω hedge mode –µ—Å–ª–∏ `trading.hedge_mode: true`
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ—Ä–¥–µ—Ä–æ–≤ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–∏—Ä–∂–∏
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
