# Архитектура портов BOT_AI_V3

## 📊 Анализ использования портов

### Основные компоненты и их порты

1. **PostgreSQL Database**
   - Порт: **5555** (не стандартный 5432)
   - Компонент: База данных
   - Статус: ✅ Работает корректно

2. **Web API (FastAPI)**
   - Порт: **8080**
   - Компонент: REST API для торговой системы
   - Конфликт: ❌ Core и API пытаются использовать один порт!

3. **Frontend (Vite)**
   - Порт: **5173**
   - Компонент: React веб-интерфейс
   - Статус: ✅ Работает корректно

4. **WebSocket Server**
   - Порт: **8081** (согласно system.yaml)
   - Компонент: Real-time обновления
   - Статус: ⚠️ Не используется в текущей версии

5. **Webhook Server**
   - Порт: **8082** (согласно system.yaml)
   - Компонент: Прием внешних сигналов
   - Статус: ⚠️ Не используется в текущей версии

6. **Prometheus Metrics**
   - Порт: **9090**
   - Компонент: Мониторинг метрик
   - Статус: ⚠️ Опционально

7. **Redis Cache**
   - Порт: **6379**
   - Компонент: Кеширование
   - Статус: ⚠️ Опционально

8. **Grafana Dashboard**
   - Порт: **3000**
   - Компонент: Визуализация метрик
   - Статус: ⚠️ Опционально

## 🔧 Проблема с портом 8080

### Текущая ситуация

1. **orchestrator.py** запускает Web API на порту 8080 внутри Core процесса
2. **unified_launcher.py** пытается запустить отдельный API процесс на том же порту 8080
3. Результат: конфликт портов!

### Решение

#### Вариант 1: Отключить API в Core при запуске через unified_launcher

```python
# В orchestrator.py
if os.getenv("UNIFIED_MODE") == "true":
    # Не запускаем API, так как он будет запущен отдельно
    pass
else:
    await self._initialize_api_servers()
```

#### Вариант 2: Использовать разные порты

- Core API: 8080
- Standalone API: 8081

## 📋 Правильная архитектура для параллельной работы

### Компоненты должны работать в следующей конфигурации

```
┌─────────────────────────────────────────────────────────┐
│                   UnifiedLauncher                        │
│                  (Управляет всеми процессами)           │
└────────────────┬───────────────────────────────────────┘
                 │
    ┌────────────┴────────────┬────────────┬─────────────┐
    │                         │            │             │
┌───▼────────────┐ ┌─────────▼────────┐ ┌─▼───────────┐ ┌─────────────┐
│ Core Process   │ │ API Process      │ │Frontend     │ │ Monitoring  │
│ (main.py)      │ │ (web/launcher.py)│ │(Vite:5173)  │ │(Prometheus) │
│                │ │ Port: 8080       │ └─────────────┘ │Port: 9090   │
│ Includes:      │ │                  │                  └─────────────┘
│ - Trading      │ │ REST API для:    │
│ - ML Engine    │ │ - Dashboard      │
│ - Strategies   │ │ - Управления     │
│ - Risk Mgmt    │ │ - Мониторинга    │
│                │ └──────────────────┘
│ NO WEB SERVER! │
└────────────────┘
        │
        │ Использует
        ▼
┌─────────────────┐
│ PostgreSQL:5555 │
└─────────────────┘
```

## 🔨 Необходимые изменения

### 1. Отключить веб-сервер в Core при запуске через unified_launcher

### 2. Убедиться что API запускается только в одном месте

### 3. Настроить правильную коммуникацию между компонентами

## 📊 Итоговая таблица портов

| Компонент | Порт | Процесс | Статус | Примечание |
|-----------|------|---------|---------|------------|
| PostgreSQL | 5555 | postgres | ✅ Активен | Основная БД |
| Web API | 8080 | web/launcher.py | ✅ Должен быть | REST API |
| Frontend | 5173 | npm run dev | ✅ Активен | React UI |
| WebSocket | 8081 | - | ⚠️ Планируется | Real-time |
| Webhook | 8082 | - | ⚠️ Планируется | Сигналы |
| Prometheus | 9090 | prometheus | ⚠️ Опционально | Метрики |
| Redis | 6379 | redis-server | ⚠️ Опционально | Кеш |
| Grafana | 3000 | grafana | ⚠️ Опционально | Дашборды |

## 🚀 Команда для запуска после исправлений

```bash
# Освободить порты если заняты
lsof -ti:8080 | xargs -r kill -9

# Запустить систему
./start_all.sh
# Выбрать 0 для unified launcher
```
