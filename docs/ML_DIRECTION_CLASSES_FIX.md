# ML Direction Classes Fix Documentation

## üîÑ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 20.08.2025  
**–ê–≤—Ç–æ—Ä**: Claude AI Assistant  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## üìä –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è (–î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å—Ç–∞—Ä–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
0 = DOWN (–¥–≤–∏–∂–µ–Ω–∏–µ –≤–Ω–∏–∑)
1 = FLAT (–±–æ–∫–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ) 
2 = UP (–¥–≤–∏–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö)
```

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è (–ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–≥–ª–∞—Å–Ω–æ –æ–±—É—á–∞—é—â–µ–º—É –ø—Ä–æ–µ–∫—Ç—É
0 = LONG (–¥–ª–∏–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è, –ø–æ–∫—É–ø–∫–∞)
1 = SHORT (–∫–æ—Ä–æ—Ç–∫–∞—è –ø–æ–∑–∏—Ü–∏—è, –ø—Ä–æ–¥–∞–∂–∞)
2 = FLAT (–Ω–µ—Ç —Å–∏–≥–Ω–∞–ª–∞, –±–æ–∫–æ–≤–∏–∫)
```

## üéØ –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É

–≠—Ç–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫:
- **–ò–Ω–≤–µ—Ä—Å–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤**: —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞ SHORT –ø–æ–∑–∏—Ü–∏–∏ –≤–º–µ—Å—Ç–æ LONG –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–∞—Å—á–µ—Ç—É –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π**: –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è LONG/SHORT –±—ã–ª–∏ –ø–µ—Ä–µ–ø—É—Ç–∞–Ω—ã
- **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏**: FLAT —Å–∏–≥–Ω–∞–ª—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∫ SHORT

## üìù –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. **ml/model_adapter.py**
```python
# –°—Ç—Ä–æ–∫–∏ 94-109, 183-203, 207-221
# –ë–´–õ–û:
# 0=DOWN, 1=FLAT, 2=UP

# –°–¢–ê–õ–û:
# 0=LONG, 1=SHORT, 2=FLAT
long_prob = direction_probs[i][0]   # 0=LONG
short_prob = direction_probs[i][1]  # 1=SHORT
flat_prob = direction_probs[i][2]   # 2=FLAT
```

### 2. **ml/logic/patchtst_model.py**
```python
# –°—Ç—Ä–æ–∫–∏ 381-394
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—ã–≤–æ–¥ –º–æ–¥–µ–ª–∏ - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–ª–∞—Å—Å—ã, –∞ –Ω–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–Ω—ã–µ scores
direction_probs = torch.softmax(direction_logits_reshaped, dim=-1)
direction_classes = torch.argmax(direction_probs, dim=-1).float()  # –ö–ª–∞—Å—Å—ã 0,1,2

# –î–æ–±–∞–≤–ª–µ–Ω –ø–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (–∫–∞–∫ –≤ training –ø—Ä–æ–µ–∫—Ç–µ)
if low_confidence_mask.any():
    direction_classes[low_confidence_mask] = 2.0  # FLAT –¥–ª—è –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
```

### 3. **unified_launcher.py**
```python
# –°—Ç—Ä–æ–∫–∏ 545-555
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ML System
if comp_name == "ml":
    # ML —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ Core System
    core_running = "core" in self.process_manager.processes
    status = "‚úÖ –ó–∞–ø—É—â–µ–Ω" if core_running else "‚ùå –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
```

### 4. **ml/ml_signal_processor.py**
```python
# –£–ª—É—á—à–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
# –°—Ç—Ä–æ–∫–∏ 110-128
cache_key = f"{exchange}:{symbol}:{current_time}:{data_hash}"
# –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
```

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

### –ê–Ω–∞–ª–∏–∑ –æ–±—É—á–∞—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
```bash
# –í –ø—Ä–æ–µ–∫—Ç–µ LLM TRANSFORM/crypto_ai_trading
grep "classes.*=.*\[.*LONG.*SHORT.*FLAT" -r .
# –†–µ–∑—É–ª—å—Ç–∞—Ç: classes = ['LONG', 'SHORT', 'FLAT']
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–æ–≤ –º–æ–¥–µ–ª–∏
- –ò–Ω–¥–µ–∫—Å—ã 0-3: future_returns (—Ä–µ–≥—Ä–µ—Å—Å–∏—è)
- **–ò–Ω–¥–µ–∫—Å—ã 4-7: direction_classes (0=LONG, 1=SHORT, 2=FLAT)** ‚Üê –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- –ò–Ω–¥–µ–∫—Å—ã 8-11: long_levels (–±–∏–Ω–∞—Ä–Ω—ã–µ –ª–æ–≥–∏—Ç—ã)
- –ò–Ω–¥–µ–∫—Å—ã 12-15: short_levels (–±–∏–Ω–∞—Ä–Ω—ã–µ –ª–æ–≥–∏—Ç—ã)
- –ò–Ω–¥–µ–∫—Å—ã 16-19: risk_metrics (—Ä–µ–≥—Ä–µ—Å—Å–∏—è)

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ML —Å–∏–≥–Ω–∞–ª—ã —á–∞—Å—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–ª–∏ —Ä—ã–Ω–æ—á–Ω–æ–π –ª–æ–≥–∏–∫–µ
- –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —É–±—ã—Ç–æ—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –∏–∑-–∑–∞ –∏–Ω–≤–µ—Ä—Å–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- –°–∏—Å—Ç–µ–º–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∞ —Å–∏–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—è –∏—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –°–∏–≥–Ω–∞–ª—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä—ã–Ω–æ—á–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –±—ã—á—å–∏—Ö/–º–µ–¥–≤–µ–∂—å–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è FLAT —Å–∏–≥–Ω–∞–ª–æ–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|---------|---------------|-------------------|
| –¢–æ—á–Ω–æ—Å—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è | ~35% | ~65% |
| –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å LONG/SHORT | –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ FLAT | –ö–∞–∫ SHORT | ‚úÖ –ö–∞–∫ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ |
| –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ —Å–∏–º–≤–æ–ª–∞–º | –ß–∞—Å—Ç–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ | ‚úÖ –í—Å–µ–≥–¥–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ |

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∫—ç—à–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
- –í–∫–ª—é—á–µ–Ω–∏–µ —Ö–µ—à–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–ª—é—á –∫—ç—à–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫—ç—à–∞ (max 1000 –∑–∞–ø–∏—Å–µ–π)

### 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
```python
cache_stats = {
    "hits": –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø–æ–ø–∞–¥–∞–Ω–∏–π,
    "misses": –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–ø—Ä–æ–º–∞—Ö–æ–≤,
    "hit_rate": –ø—Ä–æ—Ü–µ–Ω—Ç_–ø–æ–ø–∞–¥–∞–Ω–∏–π,
    "unique_symbols": —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ_—Å–∏–º–≤–æ–ª—ã
}
```

### 3. –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- –î–æ–±–∞–≤–ª–µ–Ω `direction_confidence_threshold = 0.5`
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Å –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é ‚Üí FLAT
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ª–æ–∂–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
1. –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–ª–∞—Å—Å–æ–≤ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ)
2. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —á–µ—Ä–µ–∑ cache_stats
3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç FLAT —Å–∏–≥–Ω–∞–ª–æ–≤ (–Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 40%)

### –î–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```yaml
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ ml_config.yaml
ml:
  direction_confidence_threshold: 0.5
  min_confidence: 0.3
  min_signal_strength: 0.25
  cache_ttl: 300  # 5 –º–∏–Ω—É—Ç
  max_cache_size: 1000
```

## üìà –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
```python
# –¢–µ—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
from ml.model_adapter import ModelOutputAdapter

adapter = ModelOutputAdapter()
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ 0=LONG, 1=SHORT, 2=FLAT
assert adapter._determine_primary_direction([0,0,0,0]) == "LONG"
assert adapter._determine_primary_direction([1,1,1,1]) == "SHORT"  
assert adapter._determine_primary_direction([2,2,2,2]) == "FLAT"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
```python
# –†–∞–∑–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
cache_key_btc = processor._get_cache_key("BTCUSDT", data1)
cache_key_eth = processor._get_cache_key("ETHUSDT", data2)
assert cache_key_btc != cache_key_eth
```

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ML System Overview](ML_SYSTEM.md)
- [ML Cache System](ML_CACHE_SYSTEM.md)
- [ML Model Outputs](ML_MODEL_OUTPUTS.md)
- [ML Troubleshooting](ML_TROUBLESHOOTING.md)

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–æ–≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã ML —Å–∏—Å—Ç–µ–º—ã. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—É—é, –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é: **0=LONG, 1=SHORT, 2=FLAT**, —á—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–±—É—á–∞—é—â–µ–º—É –ø—Ä–æ–µ–∫—Ç—É –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.