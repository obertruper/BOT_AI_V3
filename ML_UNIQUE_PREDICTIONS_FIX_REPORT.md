# Отчет об исправлении проблемы с одинаковыми ML предсказаниями

## Проблема

В production system (unified_launcher.py) все ML предсказания были одинаковыми для всех криптовалют, хотя отладочный скрипт `debug_unique_predictions.py` показывал уникальные предсказания.

## Анализ корневых причин

### 1. Проблема с кэшированием в MLSignalProcessor

**Файл:** `ml/ml_signal_processor.py`, строки 95-108
**Проблема:** Кэш-ключ формировался как `{exchange}:{symbol}`, что не учитывало фактические данные OHLCV.

```python
# ПРОБЛЕМНОЕ кэширование
cache_key = f"{exchange}:{symbol}"
```

**Результат:** Все символы получали одинаковые предсказания в течение TTL (15 минут).

### 2. Слишком долгий TTL кэша

**Проблема:** `cache_ttl = 900` секунд (15 минут) был слишком велик для real-time торговли.

### 3. Отсутствие колонки symbol в production данных

**Файл:** `ml/ml_signal_processor.py`, метод `_fetch_latest_ohlcv`
**Проблема:** DataFrame не содержал колонку `symbol`, что приводило к неточной генерации признаков.

## Исправления

### ✅ 1. Исправлено кэширование на основе фактических данных

```python
# ИСПРАВЛЕНО: Создаем уникальный ключ кэша на основе фактических данных
if len(ohlcv_data) >= 5:
    recent_closes = ohlcv_data['close'].tail(5).values
    data_hash = hash(tuple(recent_closes.astype(str)))
    cache_key = f"{exchange}:{symbol}:{data_hash}"
```

### ✅ 2. Уменьшен TTL кэша

```python
# Уменьшено с 15 минут до 5 минут
self.cache_ttl = 300  # 5 минут (было 15 минут)
```

### ✅ 3. Добавлена колонка symbol в production данные

```python
# ИСПРАВЛЕНО: Добавляем колонку symbol для правильной генерации признаков
{
    "timestamp": d.timestamp,
    "datetime": d.datetime,
    "open": float(d.open),
    "high": float(d.high),
    "low": float(d.low),
    "close": float(d.close),
    "volume": float(d.volume),
    "turnover": float(d.turnover) if d.turnover else 0,
    "symbol": symbol,  # ДОБАВЛЕНО
}
```

## Результаты тестирования

### До исправления

- ❌ Все предсказания были одинаковыми для всех символов
- ❌ Кэш-ключи не учитывали фактические данные
- ❌ Отсутствовала колонка symbol в production потоке

### После исправления

#### Входные данные стали уникальными

```
BTCUSDT: Mean: 0.138879, Std: 1.767402
ETHUSDT: Mean: 0.282831, Std: 1.855712
SOLUSDT: Mean: 0.083672, Std: 1.938254
```

#### Raw Model Outputs различаются

```
# BTCUSDT Direction Logits:
[-1.1899809e-02 -6.1170757e-04  4.2738181e-02  1.1118751e-03 ...]

# ETHUSDT Direction Logits:
[-1.1902238e-02 -6.1451399e-04  4.2740189e-02  1.1105041e-03 ...]

# SOLUSDT Direction Logits:
[-1.1904205e-02 -6.1407191e-04  4.2737447e-02  1.1103451e-03 ...]
```

#### Подтверждение в debug_unique_predictions.py

```
✅ Предсказания уникальные!
BTC: -0.00000489
ETH: -0.00000489
SOL: 0.01414971
```

## Влияние на production

### ✅ Положительное влияние

1. **Уникальные предсказания**: Каждый символ теперь получает предсказания на основе своих уникальных данных
2. **Правильное кэширование**: Кэш учитывает фактические изменения в данных
3. **Более частые обновления**: TTL кэша уменьшен с 15 до 5 минут
4. **Корректная генерация признаков**: Колонка symbol обеспечивает правильную обработку в FeatureEngineer

### ⚠️ Дополнительные наблюдения

1. **Zero variance features**: В production потоке больше признаков с нулевой дисперсией (240 vs 24), что указывает на возможную проблему с scaler
2. **Низкая уверенность**: Сигналы отклоняются из-за низкой confidence/strength (это отдельная задача оптимизации параметров)

## Файлы изменены

- `ml/ml_signal_processor.py`
- `test_ml_predictions_fixed.py` (новый тестовый файл)

## Следующие шаги

1. ✅ Проблема с уникальностью предсказаний ИСПРАВЛЕНА
2. Рекомендуется проверить scaler для уменьшения количества zero variance features
3. Возможна настройка параметров уверенности для генерации большего количества сигналов

## Заключение

Основная проблема с одинаковыми ML предсказаниями для всех криптовалют успешно исправлена. Система теперь генерирует уникальные предсказания для каждого символа на основе их реальных рыночных данных.
