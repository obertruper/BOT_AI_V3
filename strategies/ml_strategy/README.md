# PatchTST ML Trading Strategy

## Обзор

PatchTST ML стратегия использует передовую нейронную сеть архитектуры Transformer для прогнозирования движений криптовалютного рынка. Модель обучена на исторических данных и способна предсказывать:

- Направление движения цены (LONG/SHORT/FLAT)
- Вероятности достижения целевых уровней прибыли
- Метрики риска для управления позициями

## Архитектура модели

### UnifiedPatchTST

- **Входные данные**: 240 технических признаков
- **Контекстное окно**: 96 свечей (24 часа при 15-минутном таймфрейме)
- **Выходные данные**: 20 целевых переменных

### Структура выходов модели

1. **Future Returns (0-3)**: Предсказанные доходности для 15m, 1h, 4h, 12h
2. **Directions (4-7)**: Направления движения (0=LONG, 1=SHORT, 2=FLAT)
3. **Long Levels (8-11)**: Вероятности достижения уровней прибыли для лонгов
4. **Short Levels (12-15)**: Вероятности достижения уровней прибыли для шортов
5. **Risk Metrics (16-19)**: Максимальные просадки и ралли

## Установка и настройка

### 1. Подготовка моделей

```bash
# Создайте директорию для моделей
mkdir -p models/patchtst

# Поместите файлы модели:
# - model.pth (веса модели)
# - scaler.pkl (нормализатор данных)
# - config.pkl (конфигурация модели)
# - feature_names.pkl (опционально)
```

### 2. Конфигурация стратегии

Отредактируйте `patchtst_config.yaml`:

```yaml
models:
  model_path: "models/patchtst/model.pth"
  scaler_path: "models/patchtst/scaler.pkl"
  config_path: "models/patchtst/config.pkl"

trading:
  min_confidence: 0.65
  min_profit_probability: 0.7
  max_risk_threshold: 0.03
```

### 3. Интеграция со стратегией

```python
from strategies.ml_strategy import PatchTSTStrategy

# Создание стратегии
strategy = PatchTSTStrategy(
    name="ML_BTC_Strategy",
    symbol="BTC/USDT",
    exchange="binance",
    timeframe="15m",
    parameters={
        'model_path': 'models/patchtst/model.pth',
        'min_confidence': 0.65,
        'position_sizing_mode': 'kelly'
    }
)

# Запуск стратегии
await strategy.start()
```

## Параметры стратегии

### Основные параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `min_confidence` | Минимальная уверенность для генерации сигнала | 0.6 |
| `min_profit_probability` | Минимальная вероятность достижения прибыли | 0.65 |
| `max_risk_threshold` | Максимальный допустимый риск | 0.03 (3%) |
| `position_sizing_mode` | Режим расчета размера позиции ('kelly' или 'fixed') | 'kelly' |

### Веса таймфреймов

Стратегия использует взвешенное голосование предсказаний для разных таймфреймов:

```yaml
timeframe_weights:
  15m: 0.35   # Краткосрочные сигналы
  1h: 0.30
  4h: 0.25
  12h: 0.10   # Долгосрочные тренды
```

### Управление рисками

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `risk_multiplier` | Множитель для расчета stop-loss | 1.5 |
| `min_risk_reward_ratio` | Минимальное соотношение риск/прибыль | 2.0 |
| `kelly_safety_factor` | Коэффициент безопасности для Kelly Criterion | 0.25 |
| `max_position_pct` | Максимальный размер позиции от баланса | 0.1 (10%) |

## Алгоритм работы

### 1. Сбор данных

- Накопление минимум 96 свечей в буфере
- Обновление буфера с каждой новой свечой

### 2. Подготовка признаков

- Создание 240 технических индикаторов через FeatureEngineer
- Нормализация данных с помощью StandardScaler

### 3. Получение предсказаний

- Инференс модели на GPU (если доступен)
- Получение 20 выходных значений

### 4. Анализ предсказаний

- Взвешенное голосование по направлениям
- Проверка минимальной уверенности
- Анализ вероятностей прибыли
- Оценка рисков

### 5. Генерация сигнала

- Расчет силы сигнала
- Определение уровней stop-loss и take-profit
- Создание торгового сигнала

### 6. Расчет размера позиции

- Kelly Criterion или фиксированный риск
- Корректировка на основе силы сигнала
- Применение ограничений

## Мониторинг производительности

### Метрики стратегии

```python
metrics = strategy.get_metrics()
print(f"Точность предсказаний: {metrics['prediction_accuracy']:.2%}")
print(f"Средняя уверенность: {metrics['avg_prediction_confidence']:.2f}")
print(f"Всего предсказаний: {metrics['total_ml_predictions']}")
```

### Логирование

Стратегия логирует:

- Все сгенерированные сигналы с метаданными
- Ошибки загрузки моделей и предсказаний
- Статистику производительности

### Сохранение предсказаний

При включенной опции `save_predictions` все предсказания сохраняются для последующего анализа:

```yaml
monitoring:
  save_predictions: true
  predictions_path: "data/ml_predictions/"
```

## Оптимизация производительности

### GPU ускорение

Стратегия автоматически использует GPU если доступен:

```python
# Проверка устройства
print(f"Используемое устройство: {strategy.device}")
```

### Управление памятью

- Автоматическая очистка GPU памяти при остановке
- Ограничение размера буфера данных
- Эффективная работа с батчами

### Рекомендации по производительности

1. **Используйте GPU** для ускорения инференса в 5-10 раз
2. **Оптимизируйте batch size** в зависимости от памяти GPU
3. **Кешируйте предсказания** для одинаковых данных
4. **Используйте многопоточность** для параллельной обработки

## Адаптация под рыночные условия

### Высокая волатильность

```yaml
market_conditions:
  high_volatility:
    min_confidence: 0.75      # Повышенная уверенность
    max_risk_threshold: 0.02  # Сниженный риск
    position_sizing_mode: "fixed"
    fixed_risk_pct: 0.01      # Меньший размер позиции
```

### Трендовый рынок

```yaml
market_conditions:
  trending:
    timeframe_weights:
      4h: 0.35    # Больше веса долгосрочным сигналам
      12h: 0.15
```

## Troubleshooting

### Проблема: Модель не загружается

```python
# Проверьте пути к файлам
import os
print(os.path.exists('models/patchtst/model.pth'))
print(os.path.exists('models/patchtst/scaler.pkl'))
print(os.path.exists('models/patchtst/config.pkl'))
```

### Проблема: Низкая производительность на CPU

1. Уменьшите частоту предсказаний
2. Используйте кеширование результатов
3. Рассмотрите использование GPU

### Проблема: Out of Memory на GPU

1. Уменьшите размер батча
2. Используйте mixed precision (fp16)
3. Очищайте кеш после предсказаний

## Дальнейшее развитие

### Планируемые улучшения

1. **Ансамбль моделей** - комбинация нескольких моделей
2. **Online learning** - дообучение на новых данных
3. **Автоматическая калибровка** параметров
4. **Интеграция с внешними сигналами** (новости, sentiment)

### Экспериментальные функции

- A/B тестирование моделей
- Динамическая адаптация весов
- Мета-обучение на результатах торговли

## Контакты и поддержка

Для вопросов по ML стратегии обращайтесь в раздел Issues проекта.
