# Процесс обновления данных для индикаторов в BOT_AI_V3

## Архитектура обновления данных

### 1. **DataMaintenanceService** - Автоматическое обновление

Сервис работает в фоне и обновляет исторические данные:

```yaml
# config/system.yaml
data_maintenance:
  enabled: true
  update_interval_minutes: 5  # Обновление каждые 5 минут
  max_data_age_minutes: 60   # Максимальный возраст данных
```

**Процесс работы:**

1. Запускается автоматически при старте системы через `SystemOrchestrator`
2. Каждые **5 минут** проверяет актуальность данных для всех символов
3. Загружает недостающие свечи с биржи
4. Сохраняет в БД (таблица `raw_market_data`)

### 2. **Как работает обновление для ML сигналов**

```
Каждую минуту (signal_interval = 60 сек):
├── SignalScheduler запрашивает генерацию сигнала
├── MLSignalProcessor проверяет:
│   ├── Есть ли данные в кеше? (TTL = 15 минут)
│   │   ├── ДА → Использует кешированное ML предсказание
│   │   └── НЕТ → Загружает данные из БД
│   │       ├── _fetch_latest_ohlcv() - берет 200 последних 15-мин свечей
│   │       ├── Если данных мало → запускает update через DataLoader
│   │       └── Рассчитывает 240 индикаторов через FeatureEngineer
└── Генерирует торговый сигнал
```

### 3. **Источники данных и их обновление**

#### **База данных (PostgreSQL:5555)**

- Таблица: `raw_market_data`
- Интервал: 15-минутные свечи
- Обновление: каждые 5 минут через DataMaintenanceService

#### **Кеш индикаторов**

- Хранится в памяти (RealTimeIndicatorCalculator)
- TTL: 900 секунд (15 минут)
- Автоматически пересчитывается при истечении

#### **Биржа (Bybit API)**

- DataLoader вызывает `exchange.fetch_ohlcv()`
- Загружает только недостающие свечи
- Rate limit: соблюдается автоматически

### 4. **Расчет индикаторов**

При каждом новом ML предсказании (раз в 15 минут):

1. **FeatureEngineer** получает 200 свечей из БД
2. Рассчитывает 240 признаков:
   - Технические индикаторы (RSI, MACD, Bollinger Bands и др.)
   - Статистические показатели (volatility, skewness и др.)
   - Ценовые паттерны
   - Объемные индикаторы
   - Временные признаки

3. **Инкрементальный расчет** (пока не реализован):
   - Вместо пересчета всех 200 свечей
   - Обновляет только последнюю свечу
   - Экономит до 90% вычислений

### 5. **Временная диаграмма**

```
00:00 ─┬─ DataMaintenanceService обновляет данные из Bybit
       │
00:01 ─┼─ SignalScheduler проверяет сигналы (кеш действует)
       │
00:02 ─┼─ SignalScheduler проверяет сигналы (кеш действует)
       │  ...
00:05 ─┼─ DataMaintenanceService обновляет данные
       │
       │  ... (каждую минуту проверка, но ML не пересчитывается)
       │
00:15 ─┼─ Кеш истек! MLSignalProcessor:
       │  - Загружает свежие данные из БД
       │  - Пересчитывает все 240 индикаторов
       │  - Делает новое ML предсказание
       │  - Кеширует на следующие 15 минут
       │
00:16 ─┼─ SignalScheduler проверяет (использует новый кеш)
       │  ...
```

### 6. **Проблемы и оптимизации**

**Текущие проблемы:**

1. Полный пересчет всех индикаторов каждые 15 минут
2. Загрузка 200 свечей даже если изменилась только одна
3. Нет WebSocket для real-time обновлений

**Планируемые улучшения:**

1. **Инкрементальный расчет индикаторов** - обновлять только последние значения
2. **WebSocket подключение** - получать новые свечи в реальном времени
3. **Redis кеширование** - сохранять промежуточные расчеты между перезапусками
4. **Параллельная обработка** - рассчитывать индикаторы для разных символов параллельно

### 7. **Мониторинг актуальности данных**

Проверить актуальность данных можно через API:

```bash
curl http://localhost:8080/api/data/status
```

Или в логах:

```bash
tail -f data/logs/trading.log | grep "DataMaintenance"
```

## Итог

Система автоматически поддерживает актуальность данных:

- **Каждые 5 минут** - обновление из биржи
- **Каждую минуту** - проверка необходимости торговых действий
- **Каждые 15 минут** - пересчет ML предсказаний и индикаторов

Данные всегда актуальны с задержкой не более 5 минут от реального времени.
