# Модуль `ml`

Модуль `ml` содержит всю логику, связанную с машинным обучением. Он отвечает за полный цикл работы с ML-моделью: от подготовки данных и генерации признаков до выполнения предсказаний и их преобразования в готовые торговые сигналы.

---

## Архитектура и конвейер (Pipeline)

Процесс генерации ML-сигнала построен как последовательный конвейер:

1.  **`SignalScheduler`** (Планировщик): Каждую минуту инициирует процесс генерации сигналов для всех отслеживаемых торговых пар.
2.  **`RealTimeIndicatorCalculator`** (Калькулятор признаков): Загружает последние рыночные данные и рассчитывает для них 240+ технических индикаторов (признаков).
3.  **`MLManager`** (Менеджер модели): Принимает подготовленные признаки, нормализует их и передает в загруженную модель `UnifiedPatchTST` для получения "сырого" предсказания (вектор из 20 значений).
4.  **`MLSignalProcessor`** (Обработчик предсказаний): Принимает сырые выходы модели, интерпретирует их, анализирует качество и формирует финальный торговый сигнал (`LONG`, `SHORT`, `NEUTRAL`) с рассчитанными уровнями Stop Loss и Take Profit.
5.  **`TradingEngine`** (Торговый движок): Получает готовый сигнал от `MLSignalProcessor` и отправляет его в очередь на исполнение.

---

## Структура модуля

| Файл / Директория | Описание |
| :--- | :--- |
| **`ml_manager.py`** | **(Центральный компонент)** `MLManager`. Управляет жизненным циклом ML-модели: загружает ее в память (с оптимизацией `torch.compile`), управляет скейлером для нормализации данных и выполняет предсказания. |
| **`ml_signal_processor.py`** | `MLSignalProcessor`. Преобразует сырые выходы модели в готовый торговый сигнал. Применяет логику и фильтры для определения направления, уверенности и уровней SL/TP. |
| **`signal_scheduler.py`** | `SignalScheduler`. Работает как cron-сервис, который по расписанию (каждую минуту) запускает процесс генерации сигналов для всех настроенных символов. |
| **`realtime_indicator_calculator.py`** | `RealTimeIndicatorCalculator`. Отвечает за расчет 240+ признаков (технических индикаторов) в реальном времени на основе последних рыночных данных. |
| **`logic/`** | Содержит основную логику ML. `patchtst_unified.py` определяет архитектуру нейросети, а `feature_engineering_production.py` — логику создания признаков. |
| **`ml_prediction_logger.py`** | Специализированный логгер, который детально записывает в базу данных каждый шаг предсказания: от входных признаков до финального сигнала. |
| **`model_adapter.py`** | `ModelOutputAdapter`. Альтернативная реализация интерпретатора выходов модели. **Примечание:** Функциональность сильно пересекается с `MLSignalProcessor` и является кандидатом на рефакторинг. |
| **`config/`** | Конфигурационные файлы, специфичные для ML-подсистемы. |
| **`models/`** | Директория для хранения файлов обученных моделей (`.pth`) и скейлеров (`.pkl`). |
| **`training/`** | Содержит скрипты и утилиты для обучения и валидации моделей. |